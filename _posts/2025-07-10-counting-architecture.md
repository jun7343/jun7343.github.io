---
layout: post
title: íŠ¸ë˜í”½ ê¸‰ê²©í•˜ê²Œ ëª°ë ¤ë„ ì•ˆì •ì ìœ¼ë¡œ ì»¨í…ì¸  ì¡°íšŒìˆ˜/ì‘ì›ìˆ˜ ì¹´ìš´íŒ… í•˜ê¸°
categories: [Architecture, CS, System Design]
excerpt: íŠ¸ë˜í”½ì´ ëª°ë ¤ë„ ì¡°íšŒìˆ˜/ì‘ì›ìˆ˜ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ì¹´ìš´íŒ…í•˜ê¸° ìœ„í•œ ë‚˜ë¦„ì˜ ê³ ë¯¼
---

ì„œë¹„ìŠ¤ ìš”êµ¬ì‚¬í•­ ì¤‘ ì½˜í…ì¸ ì˜ **ì¡°íšŒìˆ˜/ì‘ì›ìˆ˜ ì¹´ìš´íŒ… ê¸°ëŠ¥**ì„ ê°œë°œí•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.  
ì´ë²ˆ ê¸€ì—ì„œëŠ” *â€œíŠ¸ë˜í”½ì´ ëª°ë ¤ë„ ì•ˆì •ì ìœ¼ë¡œ ì¹´ìš´íŒ… ê¸°ëŠ¥ì„ ì–´ë–»ê²Œ ì„¤ê³„í•  ìˆ˜ ìˆì„ê¹Œ?â€* ë¼ëŠ” ê³ ë¯¼ì„ ì •ë¦¬í•´ë³´ë ¤ í•©ë‹ˆë‹¤.

ì‚¬ì‹¤ ì–¸ëœ» ë³´ë©´ ì •ë§ ë‹¨ìˆœí•œ ê¸°ëŠ¥ ê°™ì•„ ë³´ì…ë‹ˆë‹¤. í•˜ì§€ë§Œ ì¡°ê¸ˆë§Œ ê¹Šê²Œ ë“¤ì—¬ë‹¤ë³´ë©´ ê³ ë ¤í•´ì•¼ í•  ë¶€ë¶„ì´ ë§ì€ ê¸°ëŠ¥ì´ê¸°ë„ í•©ë‹ˆë‹¤.

[![How YouTube Count Billions of Views in Milliseconds](https://img.youtube.com/vi/Nu9KPoOyKLY/0.jpg)](https://www.youtube.com/watch?v=Nu9KPoOyKLY) 
> How YouTube Count Billions of Views in Milliseconds(Updated)

[![System Design | View Counter for Videos](https://img.youtube.com/vi/MWW1prq6Rlo/0.jpg)](https://www.youtube.com/watch?v=MWW1prq6Rlo) 
> System Design View Counter for Videos

êµ¬ê¸€ë§ë§Œ í•´ë´ë„ **View Counting System Design**(ë„·í”Œë¦­ìŠ¤, ìœ íŠœë¸Œ ë“±) ê´€ë ¨ ìë£Œë¥¼ ì‰½ê²Œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
ì‚¬ì†Œí•´ ë³´ì´ëŠ” ê¸°ëŠ¥ì´ë¼ë„, ì§§ì€ ì‘ë‹µ ì„±ëŠ¥ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ì„œëŠ” ì¹˜ì—´í•œ ê³ ë¯¼ê³¼ ì„¤ê³„ê°€ í•„ìš”í•©ë‹ˆë‹¤.  

## ë‹¨ìˆœ êµ¬í˜„

ì²« ë²ˆì§¸ë¡œ ë‹¨ìˆœí•˜ê²Œ ì¡°íšŒìˆ˜ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ë¡œì§ì„ ë– ì˜¬ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```kotlin
fun findPost(id: Int): PostDto {
    val post = repository.findPost(id)
    repository.incrementPostViewCount(id)

    return post
}
```
> ì»¨í…ì¸ ë¥¼ ì¡°íšŒì‹œ í•´ë‹¹ ì»¨í…ì¸ ì˜ ì¡°íšŒìˆ˜ë¥¼ +1 ì—…ë°ì´íŠ¸ í•œë‹¤.

í•´ë‹¹ ë¡œì§ì€ ë‹¨ìˆœíˆ ì¡°íšŒìˆ˜ ì¹´ìš´íŒ…ë§Œ ë³¸ë‹¤ë©´ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. (ë¬¼ë¡  ë™ì‹œì„± ì´ìŠˆëŠ” ë³„ë„)
í•˜ì§€ë§Œ íŠ¸ë˜í”½ì´ ëª°ë¦´ ê²½ìš° í° ë¬¸ì œê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°”ë¡œ **ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ ìì› ê³ ê°ˆ** ë•Œë¬¸ì…ë‹ˆë‹¤.

---

## ì»¤ë„¥ì…˜ í’€ì˜ í•œê³„

Spring Bootì—ì„œ ë³„ë„ì˜ ì„¤ì •ì„ í•˜ì§€ ì•Šìœ¼ë©´, DBCP ê¸°ë³¸ ì»¤ë„¥ì…˜ í’€ ì‚¬ì´ì¦ˆëŠ” 10ì…ë‹ˆë‹¤.
ì¦‰ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ê¸°ë³¸ì ìœ¼ë¡œ 10ê°œì˜ ì»¤ë„¥ì…˜ë§Œ ê°€ì§€ê³  DBì— ì ‘ê·¼í•©ë‹ˆë‹¤.
![HikarConfig](/assets/images/counting-architecture/hikariConfig.png)
> HikariConfig í´ë˜ìŠ¤ ë‚´ ê¸°ë³¸ `DEFAULT_POOL_SIZE` ê°’ (ë§¨í•˜ë‹¨)

ë§Œì•½ íŠ¹ì • í¬ìŠ¤íŠ¸ê°€ ê°‘ìê¸° ëŒ€ë°•ì´ ë‚˜ì„œ íŠ¸ë˜í”½ì´ ëª°ë¦°ë‹¤ë©´ ì–´ë–»ê²Œ ë ê¹Œìš”?
í¬ìŠ¤íŠ¸ ì¡°íšŒ ìì²´ëŠ” ìºì‹±ìœ¼ë¡œ ì²˜ë¦¬í•œë‹¤ê³  í•´ë„, ì¡°íšŒìˆ˜ ì—…ë°ì´íŠ¸ëŠ” ë§¤ë²ˆ DBì— ì§ì ‘ ì“°ê¸° ì—°ì‚°ì´ ë°œìƒí•©ë‹ˆë‹¤.

ê·¸ ê²°ê³¼ ì»¤ë„¥ì…˜ í’€ì´ ë¹ ë¥´ê²Œ ì†Œì§„ë˜ê³ , ë°ì´í„°ë¥¼ í•„ìš”ë¡œí•œ ëª¨ë“  ê¸°ëŠ¥ë“¤ì´ ì»¤ë„¥ì…˜ íšë“ì„ ê¸°ë‹¤ë ¤ì•¼ í•˜ëŠ” ìƒí™©ì´ ë²Œì–´ì§‘ë‹ˆë‹¤.
> ì •í™•íˆëŠ” ì»¤ë„¥ì…˜ ë¶€ì¡± ì‹œ `Max Connection Pool Size` ë§Œí¼ ì»¤ë„¥ì…˜ì´ ì¶”ê°€ ìƒì„±ë˜ì§€ë§Œ, Idle Timeoutì— ë„ë‹¬í•˜ë©´ ì œê±°ë©ë‹ˆë‹¤.

## í”íˆ ë“œëŠ” ë‘ ê°€ì§€ ìƒê°

ì—¬ê¸°ê¹Œì§€ ì½ìœ¼ì…¨ë‹¤ë©´ ì•„ë§ˆ ì´ëŸ° ìƒê°ì„ í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
(ì €ë„ ì˜ˆì „ì— ë˜‘ê°™ì´ í–ˆë˜ ìƒê°ì…ë‹ˆë‹¤ ğŸ˜‚)

1. **DB ì»¤ë„¥ì…˜ ìˆ˜ë¥¼ ëŠ˜ë¦¬ë©´ ë˜ì§€ ì•Šì„ê¹Œ?**  
2. **Redisì—ì„œ ì¡°íšŒìˆ˜ ì¹´ìš´íŒ…ì„ í•˜ë©´ ë˜ì§€ ì•Šì„ê¹Œ?**

---

### 1. DB ì»¤ë„¥ì…˜ ìˆ˜ ëŠ˜ë¦¬ê¸°

ì»¤ë„¥ì…˜ ìˆ˜ë¥¼ ë¬´ì‘ì • ëŠ˜ë¦¬ë©´ í•´ê²°ë ê¹Œìš”? ì‚¬ì‹¤ ê·¸ë ‡ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

- **DB ì»¤ë„¥ì…˜ì€ ìœ í•œí•©ë‹ˆë‹¤.** ë‚´ ì„œë¹„ìŠ¤ ë•Œë¬¸ì— ì»¤ë„¥ì…˜ì„ ëŠ˜ë¦¬ë©´, ê°™ì€ DBë¥¼ ì‚¬ìš©í•˜ëŠ” ë‹¤ë¥¸ ì„œë¹„ìŠ¤ê°€ ì¥ì• ë¥¼ ê²ªì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
- ì»¤ë„¥ì…˜ì€ **ì§€ì† ì—°ê²° ìƒíƒœ**ì…ë‹ˆë‹¤. ì¦‰ ì„¸ì…˜ ì •ë³´ë¥¼ DBì™€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì–‘ìª½ ë©”ëª¨ë¦¬ì— ìœ ì§€í•´ì•¼ í•˜ë¯€ë¡œ ë¦¬ì†ŒìŠ¤ ì†Œëª¨ê°€ ë°œìƒí•©ë‹ˆë‹¤.  
- ë™ì‹œì— ë§ì€ ì»¤ë„¥ì…˜ì—ì„œ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ë©´, DB ì—”ì§„ì˜ CPUÂ·ë©”ëª¨ë¦¬Â·ë””ìŠ¤í¬ I/O ë¦¬ì†ŒìŠ¤ë¥¼ ë‘ê³  ê²½ìŸí•˜ê²Œ ë©ë‹ˆë‹¤. ì´ë•Œ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ë¦¬ì†ŒìŠ¤ ì´ìƒìœ¼ë¡œ ìš”ì²­ì´ ëª°ë¦¬ë©´ ì¿¼ë¦¬ê°€ ëŒ€ê¸°ì—´ì— ìŒ“ì´ê³ , ê²°êµ­ **ë³‘ëª© í˜„ìƒ**ì´ ë°œìƒí•©ë‹ˆë‹¤.

---

### 2. Redisë¡œ ì¹´ìš´íŒ… ì²˜ë¦¬í•˜ê¸°

Redisë¥¼ í™œìš©í•˜ë©´ ì–´ë–¨ê¹Œìš”?  
RedisëŠ” í‚¤-ê°’ ì €ì¥ì†Œë¡œ ë¹ ë¥¸ ì„±ëŠ¥ì„ ìë‘í•˜ì§€ë§Œ, ë‹¨ìˆœíˆ ì¡°íšŒìˆ˜ `+1` ìš©ë„ë¡œë§Œ ì“°ê¸°ì—ëŠ” **ë ˆë””ìŠ¤ ë¶€í•˜ ì§‘ì¤‘**ê³¼ **DB ë™ê¸°í™”**ë¼ëŠ” ë¬¸ì œê°€ ë‚¨ìŠµë‹ˆë‹¤.  
ì„±ëŠ¥ì ìœ¼ë¡œë‚˜ ì •í•©ì„± ë¬¸ì œë‚˜ í° ì´ìŠˆê°€ ë°œìƒí•˜ì§€ëŠ” ì•Šê² ì§€ë§Œ, ë‹¨ìˆœ ì¹´ìš´íŒ…ìš©ìœ¼ë¡œëŠ” ë‹¤ì†Œ ë¹„íš¨ìœ¨ì ì´ë¼ê³  ìƒê°í•©ë‹ˆë‹¤.

---

## ì•ˆì •ì ì¸ ë°©ë²•

ì œê°€ ìƒê°í–ˆì„ ë•Œ ì•ˆì •ì ìœ¼ë¡œ ì¡°íšŒìˆ˜/ì‘ì›ìˆ˜ ì¹´ìš´íŒ…í•˜ê¸° ìœ„í•œ í•µì‹¬ì€ ë°”ë¡œ **íš¨ìœ¨ì ì¸ ì“°ê¸° ì—°ì‚° ìš”ì²­**ì…ë‹ˆë‹¤.  
ë³´í†µ ì¡°íšŒìˆ˜/ì‘ì›ìˆ˜ëŠ” ë°˜ë“œì‹œ ì‹¤ì‹œê°„ì„±ì´ í•„ìš”í•œ ë°ì´í„°ëŠ” ì•„ë‹™ë‹ˆë‹¤.  
ë”°ë¼ì„œ ì¡°íšŒìˆ˜/ì‘ì›ìˆ˜ë¥¼ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¸ë©”ëª¨ë¦¬ì— ì¹´ìš´íŒ…í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì„¤ê³„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  

> ì¡°íšŒìˆ˜ ì¹´ìš´íŒ…ì— ëŒ€í•œ ì •ì±…ì´ë‚˜ ì„¸ë¶€ ìš”êµ¬ì‚¬í•­ì— ë”°ë¼ ì„¤ê³„ ë°©ì‹ì€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
> ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœíˆ ì¹´ìš´íŒ…ë§Œ í•œë‹¤ëŠ” ì „ì œí•˜ì— ì„¤ëª…ì„ ì´ì–´ê°€ê² ìŠµë‹ˆë‹¤.

ì•± ì¸ë©”ëª¨ë¦¬ì— ì €ì¥í•˜ë©´ ì™¸ë¶€ ì €ì¥ì†Œì™€ì˜ I/O ì‘ì—…ì´ ë°œìƒí•˜ì§€ ì•Šê¸° ë•Œë¬¸ì—  
**DB ìì› ê³ ê°ˆ ì´ìŠˆ**ì™€ **ì €ì¥ì†Œ ë¶€í•˜ ë¬¸ì œ**ë¥¼ ìƒë‹¹ ë¶€ë¶„ í•´ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```kotlin
class ContentInMemoryRepositoryImpl: ContentInMemoryRepository {

    companion object {
        private val viewCountMap = ConcurrentHashMap<Long, Long>()
    }

    override fun incrementViewCountById(id: Long) {
        viewCountMap.merge(id, 1L, Long::plus)
    }
}
```
> `incrementViewCountById` í•¨ìˆ˜ë¥¼ í†µí•´ viewCountMapì— ì»¨í…ì¸  idì™€ view countë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì¸ Spring Boot MVCì—ì„œ ì •ì  ë©”ëª¨ë¦¬ë¥¼ í™œìš©í•  ê²½ìš°, í•­ìƒ ë™ì‹œì„±ì„ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤.
Javaì—ì„œ ì œê³µí•˜ëŠ” `ConcurrentHashMap`ì€ ì´ëŸ¬í•œ ë™ì‹œì„± ë¬¸ì œë¥¼ ëŒ€ë¹„í•´ Map ë‚´ ë°ì´í„° ì¡°íšŒì™€ ê°’ ë³€ê²½ ì‘ì—…ì„ ì•ˆì „í•˜ê²Œ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> [ConcurrentHashMap in Java](https://www.geeksforgeeks.org/java/concurrenthashmap-in-java/)

ì¸ë©”ëª¨ë¦¬ì— ì¡°íšŒìˆ˜ë¥¼ ì¹´ìš´íŒ…í–ˆë‹¤ë©´ ì´ì œëŠ” DBì™€ì˜ ë™ê¸°í™” ì‘ì—…ì´ í•„ìš”í•©ë‹ˆë‹¤.  
ì¡°íšŒìˆ˜ë¥¼ ì¤€ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜í•˜ê¸° ìœ„í•´ì„œëŠ” ì§§ì€ ì£¼ê¸°ë§ˆë‹¤ DBì— ë™ê¸°í™” ì‘ì—…ì„ ì§„í–‰í•˜ëŠ” ë°©ì‹ì´ ì í•©í•©ë‹ˆë‹¤.  
ì˜ˆë¥¼ ë“¤ì–´ 5ì´ˆë§ˆë‹¤ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ ì‹¤í–‰í•´ ì¡°íšŒìˆ˜ë¥¼ DBì— ë°˜ì˜í•˜ëŠ” ì‹ì…ë‹ˆë‹¤.

```kotlin
@Component
class ContentScheduler(
    private val service: ContentService
) {
    /*
     * 5ì´ˆë§ˆë‹¤ ì¡°íšŒìˆ˜ ë™ê¸°í™”
     */
    @Scheduled(fixedRate = 5_000)
    fun synchronizeViewCount() {
        service.synchronizeViewCount()
    }
}
```
> 5ì´ˆë§ˆë‹¤ ë””ë¹„ ë™ê¸°í™” ìš”ì²­í•˜ëŠ” ìŠ¤ì¼€ì¤„ëŸ¬

```kotlin
@Service
class ContentService(
    private val jpaRepository: ContentJpaRepository,
    private val inMemoryRepository: ContentInMemoryRepository
) {

    fun synchronizeViewCount() {
        val viewCountMap = inMemoryRepository.copyViewCountMap()

        viewCountMap.forEach { (id, viewCount) ->
            jpaRepository.updateViewCount(id, viewCount)
        }
    }
}
```
> inMemory ì €ì¥ì†Œì—ì„œ ì¡°íšŒìˆ˜ ë§µì„ copy í•˜ì—¬ ì—…ë°ì´íŠ¸ í•œë‹¤.

```kotlin
@Repository
class ContentInMemoryRepositoryImpl: ContentInMemoryRepository {

    companion object {
        private val viewCountMap = ConcurrentHashMap<Long, Long>()
    }

    override fun copyViewCountMap(): Map<Long, Long> {
        val copyMap = mutableMapOf<Long, Long>()

        for (key in viewCountMap.keys) {
            /*
             * ì¡°íšŒìˆ˜ ì¹´í”¼ëœ ì»¨í…ì¸  ì •ë³´ëŠ” ì‚­ì œí•œë‹¤.
             */
            viewCountMap.remove(key)?.let {
                copyMap[key] = it
            }
        }

        return copyMap
    }
}
```
> InMemory ì €ì¥ì†Œ

ì—¬ê¸°ê¹Œì§€ ì¸ë©”ëª¨ë¦¬ì— ì¡°íšŒìˆ˜ ì¹´ìš´íŒ…í•˜ì—¬ ì§§ì€ ì£¼ê¸° ìŠ¤ì¼€ì¤„ë§ìœ¼ë¡œ DB ë™ê¸°í™”í•˜ëŠ” ì—…ë°ì´íŠ¸ ë¶€ë¶„ì…ë‹ˆë‹¤.

ì´ ë°©ì‹ì€ í•˜ë‚˜ì˜ ì»¨í…ì¸ ê°€ 5ì´ˆ ë™ì•ˆ 10ë²ˆ ì¡°íšŒë˜ë”ë¼ë„,  
ê¸°ì¡´ì²˜ëŸ¼ 10ë²ˆì˜ ì“°ê¸° ì—°ì‚°ìœ¼ë¡œ ì»¤ë„¥ì…˜ì„ ì ìœ í•˜ëŠ” ëŒ€ì‹  ë‹¨ í•œ ë²ˆì˜ ì»¤ë„¥ì…˜ ì ìœ ë¡œ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
ì¦‰, **DB ì»¤ë„¥ì…˜ ìì›ì„ í›¨ì”¬ íš¨ìœ¨ì ìœ¼ë¡œ í™œìš©**í•  ìˆ˜ ìˆê²Œ ë˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

ë¬¼ë¡  ì´ ë°©ì‹ë„ ë‹¨ì ì´ ì¡´ì¬í•©ë‹ˆë‹¤.  
1) ConcurrentHashMap ì¬í•´ì‹± ì´ìŠˆ  
2) ìŠ¤ì¼€ì¼ì•„ì›ƒ í™˜ê²½ì—ì„œ ë™ì‹œì„± ì´ìŠˆ  
3) ì• í”Œë¦¬ì¼€ì´ì…˜ ë‹¤ìš´ ì‹œ ì •í•©ì„± ì´ìŠˆ  

---
### 1. ConcurrentHashMap ì¬í•´ì‹± ì´ìŠˆ


ì²« ë²ˆì§¸ë¡œ, `ConcurrentHashMap`ì€ ê¸°ë³¸ capacity(16)ì™€ load factor(0.75)ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.  
ë§µì˜ í¬ê¸°ê°€ ì„ê³„ì¹˜(capacity * load factor)ì— ë„ë‹¬í•˜ë©´ ì¬í•´ì‹±ì´ ë°œìƒí•˜ê³ , ì´ ê³¼ì •ì—ì„œ ì§€ì—°ì´ ìƒê¹ë‹ˆë‹¤.  
> ë²„í‚· ìš©ëŸ‰ 2ë°°ìˆ˜ë¡œ ì¦ê°€í•œ ë§µ ì¶”ê°€ë˜ë©° í•´ë‹¹ ë§µìœ¼ë¡œ ë¶€í„° ë°ì´í„° ì´ê´€í•˜ëŠ” ê³¼ì •ì—ì„œ ì§€ì—°ì´ ë°œìƒí•©ë‹ˆë‹¤.

ì¶”ê°€ë¡œ ì»¨í…ì¸  ìˆ˜ê°€ ë§ì•„ì§ˆìˆ˜ë¡ ë©”ëª¨ë¦¬ ë¶€ë‹´ë„ ì»¤ì§€ë¯€ë¡œ, ì´ˆê¸° ìš©ëŸ‰ì„ ì ì ˆíˆ ê³„ì‚°í•´ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.  
ì¦‰ ì¬í•´ì‹± ì´ìŠˆë¡œ ì¸í•œ ì§€ì—° ì´ìŠˆì™€ ì´ë¥¼ ê³ ë ¤í•œ ë©”ëª¨ë¦¬ ë¶€ë‹´ì„ ê³ ë ¤í•´ì•¼í•©ë‹ˆë‹¤.

ë‹¤ë§Œ 5ì´ˆë§ˆë‹¤ DB ë™ê¸°í™” ê³¼ì •ì—ì„œ Mapì´ ë¹„ì›Œì§€ë¯€ë¡œ, â€œ5ì´ˆ ë™ì•ˆ ì–¼ë§ˆë‚˜ ë§ì€ ì»¨í…ì¸ ê°€ ì¡°íšŒë ê¹Œ?â€ë¥¼ ê³ ë ¤í•œ ì´ˆê¸°ê°’ ì„¤ì •ì„ í•˜ë©´ ë ê²ƒ ê°™ìŠµë‹ˆë‹¤.
> ì¬í•´ì‹± ê³¼ì •ì´ ê¶ê¸ˆí•˜ì‹œë‹¤ë©´ [Load Factor and Rehashing](https://www.geeksforgeeks.org/dsa/load-factor-and-rehashing/), [Load Factor in HashMap in Java with Examples](https://www.geeksforgeeks.org/dsa/load-factor-in-hashmap-in-java-with-examples/) ë¥¼ ì°¸ê³ í•˜ì‹œë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤.

---
### 2. ìŠ¤ì¼€ì¼ì•„ì›ƒ í™˜ê²½ì—ì„œ ì¡°íšŒìˆ˜ ì—…ë°ì´íŠ¸ì‹œ ë™ì‹œì„± ì´ìŠˆ

ë‘ ë²ˆì§¸ ë‹¨ì ì€ ìŠ¤ì¼€ì¼ì•„ì›ƒ í™˜ê²½ì—ì„œì˜ ë™ì‹œì„± ë¬¸ì œì…ë‹ˆë‹¤.  
ë‹¨ì¼ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œë§Œ ì¡°íšŒìˆ˜ë¥¼ DBì— ë™ê¸°í™”í•œë‹¤ë©´ í° ë¬¸ì œê°€ ì—†ì§€ë§Œ,  
ì• í”Œë¦¬ì¼€ì´ì…˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—¬ëŸ¬ ëŒ€ë¡œ í™•ì¥ë  ê²½ìš° ê° ì¸ìŠ¤í„´ìŠ¤ê°€ ë™ì¼í•œ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ ì‹¤í–‰í•˜ê²Œ ë©ë‹ˆë‹¤.  
ì´ë•Œ ë™ì¼í•œ ì»¨í…ì¸ ì˜ ì¡°íšŒìˆ˜ë¥¼ ë™ì‹œì— ì—…ë°ì´íŠ¸í•˜ë©´ì„œ ì¶©ëŒì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ë°©ë²•ìœ¼ë¡œëŠ” ë‚™ê´€ì  ë½(Optimistic Lock)ê³¼ ë¹„ê´€ì  ë½(Pessimistic Lock)ì´ ìˆìŠµë‹ˆë‹¤.  
ë¹„ê´€ì  ë½ì€ ì¶©ëŒì´ ë‚  ê²ƒì„ ì „ì œë¡œ ë°°íƒ€ì (ì“°ê¸° ì—°ì‚°ì„ ì‚¬ìš©í•œë‹¤ ê°€ì •í•˜ì—)ìœ¼ë¡œ ë½ì„ ê±¸ì–´ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ ì ‘ê·¼ì„ ë§‰ì§€ë§Œ,  
ì´ ê²½ìš° ì¡°íšŒ ê³¼ì •ì—ì„œë„ ë½ ì ìœ ë¡œ ì¸í•´ ì‚¬ìš©ì ì‘ë‹µ ì†ë„ê°€ ëŠë ¤ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
ë°˜ë©´ ë‚™ê´€ì  ë½ì€ ì¶©ëŒì´ ì—†ì„ ê²ƒì´ë¼ ê°€ì •í•˜ê³  ì»¤ë°‹ ì‹œì ì—ë§Œ ì¶©ëŒ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê¸° ë•Œë¬¸ì—  
ì„±ëŠ¥ìƒ ë” ìœ ë¦¬í•˜ê³ , ì¶©ëŒì´ ë°œìƒí•˜ë©´ ì¬ì‹œë„ë¡œ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë‚™ê´€ì  ë½ì„ ì‚¬ìš©í•  ê²½ìš°, JPAì—ì„œëŠ” ì—”í‹°í‹°ì— `@Version` ì–´ë…¸í…Œì´ì…˜ì„ ì¶”ê°€í•´ ë²„ì „ ì •ë³´ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
ì²˜ìŒ ì¡°íšŒí•œ ì‹œì ì˜ ë²„ì „ê³¼ ì»¤ë°‹ ì‹œì ì˜ ë²„ì „ì´ ë‹¤ë¥´ë©´ ì¶©ëŒì´ ë°œìƒí–ˆë‹¤ê³  íŒë‹¨í•˜ê³ ,  
ì´ë•Œ `OptimisticLockingFailureException` ì˜ˆì™¸ê°€ ë°œìƒí•©ë‹ˆë‹¤.  
ì¦‰, ì¶©ëŒì´ ê°ì§€ë˜ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ í•´ë‹¹ ì‘ì—…ì„ ì¬ì‹œë„í•´ì•¼ í•©ë‹ˆë‹¤.

ì¬ì‹œë„ëŠ” ë‹¨ìˆœíˆ try-catch ë¬¸ê³¼ ë°˜ë³µë¬¸ìœ¼ë¡œ êµ¬í˜„í•  ìˆ˜ë„ ìˆì§€ë§Œ, ì´ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì–´ì§€ëŸ½íˆëŠ” ë°©ì‹ì…ë‹ˆë‹¤.  
Springì—ì„œëŠ” `@Retryable` ê°™ì€ ì„ ì–¸ì  ë°©ë²•ì„ ì œê³µí•˜ë¯€ë¡œ ì´ë¥¼ í™œìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.  

```groovy
dependencies {
    implementation("org.springframework.retry:spring-retry:2.0.12")
}
```
> build.gradle

```kotlin
interface ContentJpaRepository: JpaRepository<ContentEntity, Long> {
    /*
     * ë‚™ê´€ì  ë½ ì˜ˆì™¸ê°€ ë°œìƒí•  ê²½ìš° ìµœëŒ€ 5ë²ˆê¹Œì§€ ì¬ì‹œë„í•©ë‹ˆë‹¤.
     */
    @Retryable(
        value = [OptimisticLockingFailureException::class],
        maxAttempts = 5
    )
    @Modifying
    @Query("update ContentEntity c set c.viewCount = :viewCount where c.id = :id")
    @Transactional
    fun updateViewCount(@Param("id") id: Long, @Param("viewCount") viewCount: Long)
}
```
> JpaRepository

ì˜ˆë¥¼ ë“¤ì–´, ì¡°íšŒìˆ˜ ì—…ë°ì´íŠ¸ ë©”ì„œë“œì— `@Retryable`ì„ ì„ ì–¸í•˜ë©´ ì¶©ëŒì´ ë°œìƒí•  ê²½ìš°  
ì§€ì •ëœ íšŸìˆ˜ë§Œí¼ ìë™ìœ¼ë¡œ ì¬ì‹œë„ê°€ ìˆ˜í–‰ë©ë‹ˆë‹¤.  
ì¬ì‹œë„ íšŸìˆ˜ëŠ” ë³´í†µ **í™•ì¥ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¸ìŠ¤í„´ìŠ¤ ìˆ˜**ì— ë§ì¶° ì„¤ì •í•˜ëŠ” ê²ƒì´ ì ì ˆí•©ë‹ˆë‹¤.
> 5ê°œì˜ ì–´í”Œë¦¬ì¼€ì´ì…˜ì´ ë™ì¼í•œ ì»¨í…ì¸  ì¡°íšŒìˆ˜ë¥¼ ì—…ë°ì´íŠ¸ í•  ì‹œ ëª¨ë“  ì–´í”Œë¦¬ì¼€ì´ì…˜ì´ 5ë²ˆ ì´ë‚´ì— ì—…ë°ì´íŠ¸ ì„±ê³µí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì—.

ë‚™ê´€ì  ë½ì„ í†µí•´ ë™ì‹œì„± ì´ìŠˆ í•´ê²°ê³¼ ì—…ë°ì´íŠ¸ ìš”ì²­ ê³¼ì •ì—ì„œ ì‹¤íŒ¨ì‹œ ì¬ì‹œë„ ìš”ì²­ì„ í†µí•´ ì •í•©ì„± ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---
### 3. ì• í”Œë¦¬ì¼€ì´ì…˜ ë‹¤ìš´ì‹œ ì¡°íšŒìˆ˜ ì •í•©ì„± ì´ìŠˆ

ì„¸ ë²ˆì§¸ ë‹¨ì ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ë‹¤ìš´ ì‹œ ë°œìƒí•˜ëŠ” ì •í•©ì„± ë¬¸ì œì…ë‹ˆë‹¤.  
ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ê°‘ìê¸° ì¢…ë£Œë˜ë©´ ì–´í”Œë¦¬ì¼€ì´ì…˜ ì¸ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ì–´ ìˆë˜ ì¡°íšŒìˆ˜ ë°ì´í„°ëŠ” DBì— ë°˜ì˜ë˜ì§€ ëª»í•˜ê³  ì‚¬ë¼ì§‘ë‹ˆë‹¤.  
ì¦‰, ìŠ¤ì¼€ì¤„ë§ ì£¼ê¸°(ì˜ˆ: 5ì´ˆ) ë‚´ì— ë°œìƒí•œ ì¡°íšŒìˆ˜ëŠ” ìœ ì‹¤ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ë¬¸ì œëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ ì¸ë©”ëª¨ë¦¬ì— ì €ì¥í•´ ì£¼ê¸°ì ìœ¼ë¡œ ë™ê¸°í™”í•˜ëŠ” ë°©ì‹ì˜ ê·¼ë³¸ì ì¸ í•œê³„ì…ë‹ˆë‹¤.  
ë”°ë¼ì„œ ì™„ë²½í•œ ì •í•©ì„±ì„ ë³´ì¥í•˜ê¸°ëŠ” ì–´ë µê³ , **ì¼ë¶€ ì¡°íšŒìˆ˜ê°€ ë°˜ì˜ë˜ì§€ ì•Šì„ ìˆ˜ ìˆë‹¤**ëŠ” ì ì„ ì„œë¹„ìŠ¤ ì„¤ê³„ ì‹œ ë°˜ë“œì‹œ ì¸ì§€í•´ì•¼ í•©ë‹ˆë‹¤.  
ì´ ë¶€ë¶„ì€ ê²°êµ­ íŠ¸ë ˆì´ë“œì˜¤í”„ë¥¼ ë°›ì•„ë“¤ì´ëŠ” ì„ íƒì´ë¼ê³  í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---
## ê²°ë¡ 

ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ ì„¤ê³„ ì˜ë„ëŠ” ì•ì„œ ë§ì”€ë“œë¦° ê²ƒì²˜ëŸ¼ **íš¨ìœ¨ì ì¸ ì“°ê¸° ì—°ì‚° ìš”ì²­**ì…ë‹ˆë‹¤.

| ![Spoon1](/assets/images/counting-architecture/spoon1.png) | ![Spoon2](/assets/images/counting-architecture/spoon2.png) |
|:----------------------------------------------------------:|:----------------------------------------------------------:|
| ìˆŸê°€ë½ì— ìŒ€ í•œ í†¨                                          | ìˆŸê°€ë½ì— ìŒ€ ê°€ë“                                           |

> í•œ í†¨ì”© ì—¬ëŸ¬ ë²ˆ ì˜®ê¸°ëŠ” ê²ƒë³´ë‹¤, í•œ ë²ˆì— ê°€ë“ ì˜®ê¸°ëŠ” ê²ƒì´ í›¨ì”¬ íš¨ìœ¨ì ì´ì§€ ì•Šì„ê¹Œìš”?

ì¦‰, ì—¬ëŸ¬ ë²ˆì˜ ì“°ê¸° ìš”ì²­ì„ ì¤„ì—¬ ë‹¤ë¥¸ ê¸°ëŠ¥ìœ¼ë¡œ ì„±ëŠ¥ ì´ìŠˆê°€ ì „íŒŒë˜ì§€ ì•Šë„ë¡ í•˜ëŠ” ê²ƒì´  
ì•ˆì •ì ì¸ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” í•µì‹¬ì´ë¼ê³  ìƒê°í•©ë‹ˆë‹¤.  
> ì»¤ë„¥ì…˜ì€ ì†Œì¤‘í•˜ë‹ˆê¹Œìš”

ë‹¤ë§Œ ì•ì„œ ì„¤ëª…ë“œë¦° ì„¤ê³„ ë°©ì‹ì—ì„œëŠ” ë°ì´í„° ì •í•©ì„±ì´ ë§ì§€ ì•ŠëŠ” ì´ìŠˆê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
â€œì •í•©ì„±ì´ ë§ì§€ ì•Šìœ¼ë©´ ë°”ë¡œ ì¹´ìš´íŒ… ì—…ë°ì´íŠ¸í•˜ëŠ” ê²Œ ë§ì§€ ì•Šì•„?â€ë¼ëŠ” ì˜ë¬¸ì´ ìƒê¸¸ ìˆ˜ ìˆê³ , ì´ ë¶€ë¶„ì—ì„œ ê³ ë¯¼ì´ ìƒê¹ë‹ˆë‹¤.  
ì´ ì ì´ ë°”ë¡œ íŠ¸ë ˆì´ë“œì˜¤í”„ë¼ ìƒê°ë©ë‹ˆë‹¤. **ì•ˆì •ì ì¸ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” ëŒ€ì‹  ì™„ë²½í•œ ì •í•©ì„±ì€ í¬ê¸°í•  ê²ƒì¸ì§€,  
ì•„ë‹ˆë©´ ì™„ë²½í•œ ì •í•©ì„±ì„ ë³´ì¥í•˜ëŠ” ëŒ€ì‹  ì„±ëŠ¥ ì´ìŠˆë¥¼ ê°ì•ˆí•  ê²ƒì¸ì§€**ì— ëŒ€í•œ ì„ íƒì´ í•„ìš”í•œ ê²ƒì´ì£ .  

ë”°ë¼ì„œ ìš°ë¦¬ëŠ” í•´ë‹¹ ë°ì´í„°ê°€ ë°˜ë“œì‹œ ì •í•©ì„±ì„ ìš”êµ¬í•˜ëŠ” ë°ì´í„°ì¸ì§€ ëª…í™•íˆ ì¸ì§€í•  í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤.  
ì´ ë…¼ì˜ëŠ” ì œí’ˆ ìš”êµ¬ì‚¬í•­ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë©°, ì¶©ë¶„í•œ ë…¼ì˜ í›„ ê²°ì •í•˜ëŠ” ê²ƒì´ ë°”ëŒì§í•©ë‹ˆë‹¤.

ì¶”ê°€ë¡œ ì¤‘ë³µ ì¡°íšŒìˆ˜ ê°ì§€ë‚˜ ì¡°íšŒ ë¡œê¹…ê¹Œì§€ ê³ ë ¤í•œë‹¤ë©´,  
â€œì²˜ìŒë¶€í„° Kafkaë¥¼ ë„ì…í•´ì„œ ì¡°íšŒìˆ˜ë¥¼ ì²˜ë¦¬í•˜ë©´ ë˜ì§€ ì•Šì„ê¹Œ?â€ë¼ëŠ” ì§ˆë¬¸ë„ ë‚˜ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
ë¬¼ë¡  ì¢‹ì€ ë°©ë²•ì¼ ìˆ˜ ìˆì§€ë§Œ, ì‹œìŠ¤í…œ ê´€ë¦¬ ë³µì¡ë„ê°€ í¬ê²Œ ì˜¬ë¼ê°‘ë‹ˆë‹¤.  
ë§Œì•½ ì¡°íšŒìˆ˜ ì¹´ìš´íŒ…ì— ëŒ€í•œ ì„¸ë¶€ ìš”êµ¬ì‚¬í•­ì´ ëª…í™•í•˜ì§€ ì•Šë‹¤ë©´ ì„£ë¶ˆë¦¬ Kafka ë„ì…ì€ ì§€ì–‘í•´ì•¼ í•œë‹¤ê³  ìƒê°í•©ë‹ˆë‹¤.  
> ì ìš©í•œë‹¤ë©´ í† í”½ ì ì¬ ë¹„ìš©ê³¼ ìµœì í™” ë°©ë²•ê¹Œì§€ í•¨ê»˜ ê³ ë¯¼í•´ì•¼ í•  ê²ƒì…ë‹ˆë‹¤.

ë˜ ëˆ„êµ°ê°€ì—ê² ì‘ì€ íŠ¸ë˜í”½ì— ê´œí•œ ìœ ë‚œì´ë¼ëŠ” ë§ì´ ë‚˜ì˜¬ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.  
ë¬¼ë¡  ìœ íŠœë¸Œ ì‚¬ë¡€ì²˜ëŸ¼ ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ëŒ€ìš©ëŸ‰ íŠ¸ë˜í”½ì„ ê²½í—˜í•˜ë©°  
ì¡°íšŒìˆ˜ë§Œ ì „ë‹´í•˜ëŠ” ë³„ë„ ì‹œìŠ¤í…œì„ ì„¤ê³„í•˜ë©´ ì¢‹ê² ì§€ë§Œ, í˜„ì‹¤ì ìœ¼ë¡œëŠ” ì‰½ì§€ ì•ŠìŠµë‹ˆë‹¤.  
> ë¶ˆí•„ìš”í•œ ì˜¤ë²„ ì—”ì§€ë‹ˆì–´ë§ì´ ë  ìˆ˜ ìˆìœ¼ë‹ˆê¹Œìš”.

ì €ëŠ” ê·¸ë ‡ë‹¤ê³  í•´ì„œ ë‹¨ìˆœíˆ ì•ˆì¼í•˜ê²Œ ì²˜ë¦¬í•  ìˆ˜ë„ ì—†ì—ˆìŠµë‹ˆë‹¤.  
ê·¸ë˜ì„œ ë‚˜ë¦„ëŒ€ë¡œ ê¹Šì´ ê³ ë¯¼í–ˆë˜ ë‚´ìš©ì„ ì´ë ‡ê²Œ ê¸€ë¡œ ì •ë¦¬í•´ ë³´ì•˜ìŠµë‹ˆë‹¤.  

ê¸´ ê¸€ ì½ì–´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤ ğŸ™
